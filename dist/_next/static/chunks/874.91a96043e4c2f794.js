(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[874],{7874:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return L}});var i=a(4810),l=a(5719),n=a(4576),s=a(2190),r=a(5027),o=a.n(r);class c{size(){return this.events.size}emitSync(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];let i=[];return this.events.forEach(e=>{i.push(e(...t))}),i}emitLifeCycle(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return this.lastEmitArgs=t,Promise.resolve().then(()=>{try{this.emitSync(...t)}catch(e){return Promise.reject(e)}})}emit(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return Promise.resolve().then(()=>{try{this.emitSync(...t)}catch(e){return Promise.reject(e)}})}on(e){return this.lastEmitArgs&&e(...this.lastEmitArgs),this.events.add(e),()=>{this.off(e)}}wait(){return new Promise(e=>{let t=this.on(function(){for(var a=arguments.length,i=Array(a),l=0;l<a;l++)i[l]=arguments[l];e(i),t()})})}off(e){this.events.delete(e)}destroy(){this.events.clear()}constructor(){this.events=new Set}}var d=a(2869),u=a(7498),h=a.n(u),p=a(2061),f=a.n(p);function y(e,t,a,i){let l="string"==typeof e?f().parse(e):e,n={};return!function e(i){i&&"object"==typeof i&&("SubQuery"===i.type&&(i.value=y(i.value,t,a)),"TableFactor"===i.type&&(i.alias&&i.alias.value?n[i.alias.value]=i.value.value:n[i.value.value]=i.value.value,i.value.value=a[g(i.value.value)]||i.value.value),Object.keys(i).forEach(t=>{"object"==typeof i[t]&&e(i[t])}))}(l),!function e(l){if(l&&"object"==typeof l&&"TableFactor"!==l.type){if("Identifier"===l.type){if(l.value.includes(".")){let[e,i]=l.value.split("."),s=n[e],r=t[s]&&t[s][i];if(r){let t=a[g(e)]||e;l.value="".concat(t,".").concat(r)}}else Object.keys(t).some(e=>{let i=a[g(e)]||e,n=t[e][l.value];if(n)return l.value="".concat(i,".").concat(n),!0})}"SelectExpr"===l.type&&(null==i||i.forEach(e=>{l.value.push({type:"Identifier",value:e,alias:null,hasAs:null})})),Object.keys(l).forEach(t=>{"object"==typeof l[t]&&e(l[t])})}}(l),Object.defineProperty(l,"toString",{value:()=>f().stringify(l)}),l}function g(e){return e.startsWith("`")&&e.endsWith("`")?e.substring(1,e.length-1):e}let m=new class{async getRecordIds(e){return e||(e=await this.getActiveTable()),await e.getRecordIdList()}async getRecordById(e,t){return await e.getRecordById(t)}async getActiveTable(){return this.activeTable||(this.activeTable=await s.ws.base.getActiveTable()),this.activeTable}async getTableList(){return await s.ws.base.getTableList()}async getFieldList(e){let t=await e.getFieldList();for(let e=0;e<t.length;e++){let a=t[e];a.name=await a.getName()}return t}async getSelection(){return await s.ws.base.getSelection()}async getSelectionQuery(e){let t=e.tableId?await this.base.getTableById(e.tableId):void 0,a={table:t,view:e.viewId?await (null==t?void 0:t.getViewById(e.viewId)):void 0,field:e.fieldId?await (null==t?void 0:t.getFieldById(e.fieldId)):void 0,record:e.recordId?await (null==t?void 0:t.getRecordById(e.recordId)):void 0};return a}async getSelection2(){let{viewId:e=!1,fieldId:t=!1,recordId:a=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=await this.getSelection();return await this.getSelectionQuery({viewId:e?i.viewId:void 0,fieldId:t?i.fieldId:void 0,recordId:a?i.recordId:void 0})}async getRecordList(e,t){let a;let i=[];for(;;){let l=await e.getRecords({pageSize:5e3,...t,pageToken:a});if(i.push(...l.records),a=l.pageToken,!l.hasMore)break}return i}async getDisplayRecordList(e,t,a){let i=await this.getRecordList(e,a);console.log("fields:",t);let l=[];for(let e=0;e<i.length;e++){let a=i[e];l.push({_id:a.recordId,...function(e,t){let a={};return e.forEach(e=>{var i,l,n,r,o;let c=t.fields[e.id];e.type===s.fS.DateTime&&"dateFormat"in e.property&&c?(a[e.id]=(0,d.Z)(c,null===(i=e.property)||void 0===i?void 0:i.dateFormat),a["ts_"+e.name]=c):e.type===s.fS.Url&&c?a[e.id]=null===(l=c[0])||void 0===l?void 0:l.link:a[e.id]="object"==typeof c?null!==(o=null==c?void 0:c.text)&&void 0!==o?o:null==c?void 0:null===(n=c.map)||void 0===n?void 0:n.call(c,e=>null!==(r=null==e?void 0:e.text)&&void 0!==r?r:null==e?void 0:e.name).filter(e=>e).join(","):c,a._raw_=t.fields}),a}(t,a)})}return l}constructor({onSelectionChange:e=!1,immediatelySelectionChange:t=!0}={}){this.bitable=s.ws,this.base=s.ws.base,this.emSelectionChange=new c,e&&this.base.onSelectionChange(async e=>{this.activeTable=void 0,this.emSelectionChange.emitLifeCycle(e)}),t&&e&&this.getSelection().then(e=>{this.emSelectionChange.emitSync({data:e})})}}({}),w=new class{async fetchTables(){let e=new Map,t=new Map,a=new Map,i=await this.sdk.getTableList();i.map(t=>e.set(t.id,t));let l=[];await Promise.all(i.map(async e=>{let t=await e.getName();l.push({name:t,id:e.id})})),l.sort((e,t)=>t.name.length-e.name.length).forEach(e=>{t.set(e.name,e.id),a.set(e.id,e.name)}),this.emFetchTableList.emitLifeCycle({tableMap:e,tableIdMapName:a,tableNameMapId:t,tableList:i})}extractName(e,t){let a=[];return t.forEach(t=>{e.includes(t)&&a.push(t)}),a}async query(e){let t=(await this.sdk.getActiveTable()).id,[a]=await this.emFetchTableList.wait();console.log("1sql:",e=e.replace(/FROM\s+(\?)\s?/gim,"FROM ".concat(t," "))),console.log("sql:",e=y(e,{},function(e){let t={};return e.forEach((e,a)=>{t[a]=e}),t}(a.tableNameMapId))+"");let i=this.extractName(e,Array.from(a.tableNameMapId.values()));console.log("tableListCtx:",a),console.log("selectTablesId:",i);let l={},n=new Map,s=h().tables;return await Promise.all(i.map(async e=>{let t=a.tableMap.get(e),i=await this.sdk.getRecordList(t),r=await t.getFieldMetaList(),o=await this.sdk.getDisplayRecordList(t,r),c=function(e){let t={},a={};return e.forEach(e=>{a[e.id]=e.name,t[e.name]=e.id}),{fieldsMapName:t,fieldsMapId:a}}(r);l[e]=c.fieldsMapName,n.set(e,c),console.log("selectTables:",t,i,o),s[e]={data:o}})),this.emFetchTableListFields.emitLifeCycle(n),console.log("res:",e=y(e,l,{},["_id"])+"",l),h()(e)}constructor(e){this.sdk=e,this.emFetchTableList=new c,this.emFetchTableListFields=new c,this.fetchTables()}}(m);var b=a(5736),v=a(8374),x=a(6486),S=a(5171);async function j(e,t,i){let l=await a.e(666).then(a.t.bind(a,2389,23)),n=new l.Workbook,s=n.addWorksheet("Sheet1");s.addTable({name:"Sheet1",ref:"A1",headerRow:!0,totalsRow:!1,style:{showRowStripes:!0,showFirstColumn:!0},columns:t,rows:i}),s.columns.forEach(e=>e.width=10);let r=await n.xlsx.writeBuffer();!function(e,t){let a=new Blob([e]),i=URL.createObjectURL(a),l=document.createElement("a");l.href=i,l.download=t,l.style.display="none",document.body.appendChild(l),l.click(),URL.revokeObjectURL(i),document.body.removeChild(l)}(r,e)}function L(){let[e,t]=(0,n.useState)("select * from ?"),[a,r]=(0,n.useState)(1),{exec:c,onExec:d,error:u,pageSize:h=0,total:p=0,columns:f,result:y}=function(){let[e,t]=(0,n.useState)(),[a,i]=(0,n.useState)(),[l,s]=(0,n.useState)(),[r,o]=(0,n.useState)(),[c,d]=(0,n.useState)(),u=(0,n.useCallback)(async(e,t,a)=>{let i=await w.query(e),[l]=await w.emFetchTableList.wait(),[n]=await w.emFetchTableListFields.wait(),s=new Map;n.forEach(e=>{Object.keys(e.fieldsMapId).forEach(t=>{s.set(t,e.fieldsMapId[t])})});let o=Object.keys(i[0]||{}).filter(e=>!["_id","_raw_"].includes(e)).map(e=>({title:s.get(e)||e,width:100,dataIndex:e,key:e}));return{tableName:await l.tableList[0].getName(),columns:o,result:i,total:c,pageSize:r}},[]),h=(0,n.useCallback)(async(e,a,l)=>{i("");try{let{columns:i,result:n,total:r,pageSize:c}=await u(e,a,l);d(r),o(c),s(i),t(n)}catch(e){console.error(e),i(String(e))}},[u]);return{result:e,error:a,columns:l,exec:u,onExec:h,pageSize:r,setPageSize:o,total:c}}(),[g,m]=(0,n.useState)(!1),L=(0,n.useCallback)(e=>t(e),[]),k=(0,n.useCallback)(async()=>{if(g){l.FN.warning({content:"querying..."});return}m(!0),r(1),await d(e,-1,!0),m(!1)},[g,d,e]),I=!(h>=p)&&{currentPage:a,size:"small",pageSize:h,total:p,position:"top",hideOnSinglePage:!0,formatPageText:e=>"当前 SQL 查询的是 ".concat(null==e?void 0:e.currentStart,"条 到 ").concat(null==e?void 0:e.currentEnd,"条 的数据"),onPageChange:async t=>{m(!0),r(t),await d(e,t-1,!1),m(!1)}},[C,T]=(0,n.useState)(!1),F=(0,n.useCallback)(async()=>{let t=await s.ws.base.getPermission({entity:s.lR.Base,type:s.C8.Printable});if(!t){l.FN.warning({content:"no permission"});return}if(C){l.FN.warning({content:"exporting..."});return}T(!0);try{let t=await c(e,-1);j(t.tableName+".xlsx",...function(e,t){let a=[],i=e.map(e=>({name:e.title}));for(let i=0;i<t.length;i++){let l=t[i],n=[];for(let t=0;t<e.length;t++){let a=e[t],i=a.key;n.push(l[i])}a.push(n)}return[i,a]}(t.columns,t.result))}catch(e){console.error(e),l.FN.error({content:"export error: ".concat(e)})}T(!1)},[c,C,e]),R=(0,n.useCallback)(()=>{window.open("http://sqlmother.yupi.icu/#/learn")},[]),E=(0,n.useCallback)(()=>{window.open("https://github.com/WumaCoder/bs-sql")},[]);return(0,i.jsxs)("main",{className:o().main,children:[(0,i.jsxs)(l.X2,{style:{padding:"0.5rem"},children:[(0,i.jsx)(l.JX,{span:18,children:(0,i.jsx)(l.II,{defaultValue:e,onChange:L})}),(0,i.jsx)(l.JX,{span:4,style:{paddingLeft:"5px"},children:(0,i.jsx)(l.zx,{type:"primary",block:!0,theme:"solid",onClick:k,children:"Query"})}),(0,i.jsx)(l.JX,{span:2,style:{paddingLeft:"5px"},children:(0,i.jsx)(l.Lt,{trigger:"click",position:"bottomRight",render:(0,i.jsxs)(l.Lt.Menu,{children:[(0,i.jsx)(l.Lt.Item,{icon:C?(0,i.jsx)(l.yC,{}):(0,i.jsx)(b.Z,{}),onClick:F,children:"Export"}),(0,i.jsx)(l.Lt.Item,{icon:(0,i.jsx)(v.Z,{}),onClick:R,children:"Help"}),(0,i.jsx)(l.Lt.Item,{icon:(0,i.jsx)(x.Z,{}),onClick:E,children:"Github"})]}),children:(0,i.jsx)(l.zx,{icon:(0,i.jsx)(S.Z,{})})})})]}),u&&(0,i.jsx)("div",{style:{margin:"0px 0.5rem"},children:(0,i.jsx)(l.jL,{fullMode:!1,type:"warning",bordered:!0,description:(0,i.jsx)("p",{style:{whiteSpace:"pre-wrap",color:"red",wordSpacing:"0.5em"},children:u})})}),(0,i.jsx)("div",{children:(0,i.jsx)(l.iA,{columns:f,dataSource:y,pagination:I,loading:g})})]})}},5027:function(e){e.exports={main:"App_main__hJIzP",h4:"App_h4__VmZi6",code:"App_code__MlZfd"}}}]);
//# sourceMappingURL=874.91a96043e4c2f794.js.map